---
title: "Exploratory data analysis"
author: "Patrick Mathias"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)
```

# Exploratory Data Analysis

In this section of the course we will walk through a common workflow: exploring a new data set.

First let's refresh your memory on loading in a data set. We have an Excel file that contains our main data set in the data folder called "orders_data_set.xlsx". After loading the file into a variable (in this case a data frame) called "orders", look at the structure of the data using the `str` command

```{r load_data}
orders <- read_excel("data/orders_data_set.xlsx")
str(orders)
```

> *Exercise 1*
>
> 1. Which fields of the data frame are characters?
> 
> 2. Which are numbers?
>
> 3. Of those fields above, which would be best represented as factors?
>
> 4. Let's start by running a summary (`summary`) of one of those character fields that we think should be a factor. What information can we determine from that summary?
>
> 5. Let's convert one of those fields to a factor using the `as.factor` command and then run a summary. What additional information do you see by converting to a factor?

Tip: White space generally has meaning in programming. When a variable name has a space in it, you can use the `` ` `` character (look to the top left on your keyboard) around the variable name to make sure R understands what variable you are referring to. As an example, `summary(orders$Proc Code)` will not work but `summary(orders$```Proc Code```)` will.

White spaces in names can be annoying to deal with. To get around this, we can rename variable names to remove white spaces, and, in addition, we can convert everyting to a single case (lowercase by default). The janitor package has some handy data science tools, including the ability to clean up variable names in one line using the `clean_names` function:

```{r load_data_clean_headers}
orders <- read_excel("data/orders_data_set.xlsx") %>%
  clean_names()
str(orders)
```

As you may have seen already, there is more than one way to do the same thing when you're programming. We used `str()` to look at the structure of a data frame or other object. Another way to do this is to use the `glimpse()` function, which produces very similar output but is organized a little more neatly (with 1 line per variable).
```{r glimpse}
glimpse(orders)
```

```{r summary}
summary(orders)
```

```{r convert_factor}
summary(orders$order_status_c_descr)
summary(as.factor(orders$order_status_c_descr))
```
```{r}
orders <- orders %>%
  mutate(department_fctr = as.factor(department))
summary(orders$department_fctr)
```

```{r convert_all_factors}
orders <- orders %>%
  mutate_if(is.character, as.factor)
summary(orders)
```

```{r skim}
library(skimr)
skim(orders)
```

```{r}
orders <- orders %>%
  mutate(order_week = floor_date(order_time, unit = "week"))
ggplot(orders, aes(x = order_week)) + 
  geom_histogram(binwidth = 7*24*60*60)
```

```{r cbc_analysis}
cbd_orders <- orders %>%
  filter(proc_code == "CBD")
table(cbd_orders$department, cbd_orders$order_status_c_descr)
```

```{r tabyl}
cbd_orders %>% 
  tabyl(department, order_status_c_descr) %>%
  adorn_totals("row") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting() %>%
  adorn_ns()
```

