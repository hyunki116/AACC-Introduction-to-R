---
title: "exploratory analysis joe"
author: "Joe Rudolf"
date: "6/21/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)

orders <- read_excel("data/orders_data_set.xlsx")

orders <- clean_names(orders)

```

#Take a quick peak at the data

```{r}

glimpse(orders)

```


# 1 Plotting Time Points for Data Exploration

What time of day are tests ordered?

```{r}

order_hour = hour(orders$order_time)

ggplot(orders, aes(x = order_hour)) + 
  geom_histogram(bins = 24)

```

Exercise:  What time of day are tests resulted?

```{r}

result_hour = hour(orders$result_time)

ggplot(orders, aes(x = result_hour)) + 
  geom_histogram(bins = 24)

```

# 2 Exploring Time Intervals and Plotting the Data


Look only at orders that were completed (exclude cancelled orders)

```{r}

completed_orders <- filter(orders, order_status_c_descr == "Completed")

```

Add column to calculate date difference, limit to 0 - 24 hour window, plot


```{r}

otr_delta <- mutate(completed_orders, order_time_to_result_time = result_time - order_time)

otr_delta <- filter(otr_delta, order_time_to_result_time > 0 & order_time_to_result_time < 60*60*24)

ggplot(otr_delta, aes(x = order_time_to_result_time)) + 
  geom_histogram(binwidth = 60*60)

```


Exercise:  What if we wanted to look at result time to review time?

```{r}

rtr_delta <- mutate(completed_orders, result_time_to_review_time = review_time - result_time)

rtr_delta <- filter(rtr_delta, result_time_to_review_time > 0 & result_time_to_review_time < 60*60*24 )

ggplot(rtr_delta, aes(x = result_time_to_review_time)) + 
  geom_histogram(binwidth = 60*60)

```

# 3 Counting Tests Per Patient

Counting Total Numbers of Completed Tests Per Patient

```{r}

orders_count <- completed_orders %>%
  count(patient_id)

ggplot(orders_count, aes(x = n)) +
   geom_histogram(binwidth = 1)

```


Exercise:  What if we wanted to know only number of CBCs per patient

```{r}

cbc_orders <- filter(completed_orders, proc_code == "CBC")

#Group and Count

cbc_count <- cbc_orders %>%
  count(patient_id)

#Plot

ggplot(cbc_count, aes(x = n)) + 
  geom_histogram(binwidth = 1)

```

# 4 Date Differential by Patient/Test

Time Between CBCs

```{r}


cbc_orders <- filter(completed_orders, proc_code == "CBC")

cbc1 = select(cbc_orders, patient_id, result_time)
cbc2 = select(cbc_orders, patient_id, result_time)

cbc_join <- full_join(cbc1, cbc2, by= "patient_id")

cbc_join

cbc_join <- mutate(cbc_join, cbc_time_diff = result_time.x - result_time.y)

cbc_join <- filter(cbc_join, cbc_time_diff > 0)

ggplot(cbc_join, aes(x = cbc_time_diff)) + 
  geom_histogram(binwidth = 60*60*24*7)



```


# More joining:

What routes do orders come from

```{r}

orders_details <- read_csv("data/order_details.csv")

joined_data <- left_join(completed_orders, orders_details, by = "order_id")

joined_count <- joined_data %>%
  count(pref_list_type)

joined_count

```



Exercise:  What if we just wanted to look at Factor V Leiden (proc_code = "F5DNA")

```{r}

orders_details <- read_csv("data/order_details.csv")

F5DNA <- filter(completed_orders, proc_code == "F5DNA")

F5DNA_joined <- left_join(F5DNA, orders_details, by = "order_id")

F5DNA_joined_count <- F5DNA_joined %>%
  count(pref_list_type)

```



# Experimentation below here.


What are the most frequently ordered tests during the time period (follow up Exericse to Patrick's Department Summary, include in his section)

```{r}

proc_summary <- orders %>%
  mutate(proc_code_fctr = as.factor(proc_code))

summary(sort(proc_summary$proc_code_fctr))

```










